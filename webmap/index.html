<!DOCTYPE html>
<html>

<head>
    <title>Mer de glace ice flow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="//unpkg.com/leaflet@1.4.0/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,400" rel="stylesheet">
    <script
			  src="http://code.jquery.com/jquery-2.2.4.js"
			  integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI="
			  crossorigin="anonymous"></script>
    <link rel="stylesheet" href="//unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="//unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
</head>

<body>
    <div id="map"></div>

    <!-- CDN -->
    <script src="//d3js.org/d3.v4.min.js"></script>
    <script src="//npmcdn.com/leaflet@1.4.0/dist/leaflet.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.0/chroma.min.js"></script>
    <script src="//unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>
    <script src="//unpkg.com/leaflet.markercluster.layersupport@2.0.1/dist/leaflet.markercluster.layersupport.js"></script>
		

    <!-- Plugins -->
    <!-- raster layers -->
    <script src="https://ihcantabria.github.io/Leaflet.CanvasLayer.Field/dist/leaflet.canvaslayer.field.js"></script>
    
    <!-- esri basemaps -->
    <script src="https://unpkg.com/esri-leaflet@2.2.3/dist/esri-leaflet.js"
    integrity="sha512-YZ6b5bXRVwipfqul5krehD9qlbJzc6KOGXYsDjU9HHXW2gK57xmWl2gU6nAegiErAqFXhygKIsWPKbjLPXVb2g=="
    crossorigin=""></script>

    <script>
        let map = L.map("map");
        
	// esri basemaps 
        imagery=L.esri.basemapLayer('Imagery');
	labels=L.esri.basemapLayer('ImageryLabels');
	im_bm=L.layerGroup([imagery,labels]).addTo(map);

	tp_bm=L.esri.basemapLayer('Topographic');
      
        // Put a scale
        L.control.scale({imperial:false}).addTo(map);

        // test importing geoJson data
	//var photoImg = '<img src="data/picture.jpg" height="150px" width="150px"/>';

	var geojsonFeature=$.getJSON("data/points.geojson", function(data) {
	     datalayer = L.geoJson(data, {
	          onEachFeature: function (feature, layer) {
		  layer.bindPopup("This is a GPS <br>");}
		  });
         L.markerClusterGroup.layerSupport().addTo(map).checkIn(datalayer);
         // var   markers = L.markerClusterGroup();
	 // markers.addLayer(datalayer);
	 // map.addLayer(markers)
	  });

        // Vectorfield animations
        d3.text('data/UMdg.asc', function (u) {
            d3.text('data/VMdg.asc', function (v) {
	        // get vector component
                let vf = L.VectorField.fromASCIIGrids(u, v, 1.0); 
                var range = [0,500]
                var scale = chroma.scale('YlOrRd').domain(range);

                // Simple colorbar
                var bar = L.control.colorBar(scale, range, {
                    title: 'surface velocity (m/a)',
                    units: 'm/a',
                    steps: 100,
                    decimals: 1,
                    width: 150,
                    height: 5,
                    position: 'bottomright',
                    background: '#000',
                    textColor: 'white',
                    labels: [range[0],range[1]/4,range[1]/2,3*range[1]/4,range[1]],
                    labelFontSize: 8
                });
                
                // a) get magnitude
                const s = vf.getScalarField('magnitude'); // << derived ScalarField
                const magnitude = L.canvasLayer.scalarField(s, {
                    color: scale,
                    opacity: 0.65,
                });

                // b) get vector animation 
                let layer = L.canvasLayer.vectorFieldAnim(vf, {
                    paths: 1000,
                    color: scale,
                    width: 2,
                    maxAge: 400 ,
                    fade: 0.98,
                    velocityScale: 1 / 1000000,
                    mouseMoveCursor: null
                });

		// center map on raster layer
                map.fitBounds(layer.getBounds());

                // control button
                L.control.layers({
		   "Imagery": im_bm,
		   "Topographic": tp_bm,
		}, {
                    "Derived magnitude": magnitude,
                    "Vector animation": layer,
		    "Tools": datalayer,
                }, {
                        position: 'topright',
                        collapsed: false
                    }).addTo(map);

   //  create a custom control to ad a title and credential to the map
   // https://stackoverflow.com/questions/28316273/mapbox-map-styling-for-description-box/28319456#28319456
              var MyCustomControl = L.Control.extend({
                  options: {
                   // Default control position
                     position: 'topright'
                   },
                  onAdd: function (map) {
                   // Create a container with classname and return it
                   return L.DomUtil.create('div', 'my-custom-control');
                   },
                  setContent: function (content) {
                  // Set the innerHTML of the container
                  this.getContainer().innerHTML = content;
                  }
               });

              var myCustomControl =  new MyCustomControl().addTo(map);
               
	      // interaction when layer turn on/off 
               map.on('overlayadd', function (eventLayer) {
                 if (eventLayer.name === 'Derived magnitude') {
		  // add legend
                  bar.addTo(map);
		  // if vector animation is on; put it on top with cyan color
                  if (map.hasLayer(layer)) {
                    //map.removeLayer(layer);
                    //layer.addTo(map);
                    layer.options.color = 'cyan';
                  }
                 } else if (eventLayer.name === 'Vector animation') {
                   myCustomControl.setContent('Ice flow surface velocities');
                   if (map.hasLayer(magnitude)) {layer.options.color = 'cyan'}
                   else {layer.options.color = scale}
                 }
                });
                map.on('overlayremove', function (eventLayer) {
               // Switch to the Permafrost legend...
                 if (eventLayer.name === 'Derived magnitude') {
                  map.removeControl(bar);
                  if (map.hasLayer(layer)) {layer.options.color = scale}
                 } else if (eventLayer.name === 'Vector animation') {
		   myCustomControl.setContent('');
		 }
                });
                
                
                // get velocity by clicking on layer
                layer.on('click', function (e) {
                    if (e.value !== null) {
                        let vector = e.value;
                        let v = vector.magnitude().toFixed(2);
                        let d = vector.directionTo().toFixed(0);
                        let html = (`<span class="popupText">${v} m/a </span>`);
                        let popup = L.popup()
                            .setLatLng(e.latlng)
                            .setContent(html)
                            .openOn(map);
                    }
                });

            });
        });
    </script>
</body>

</html>
